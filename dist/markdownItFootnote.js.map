{"version":3,"file":"markdownItFootnote.modern.js","sources":["../index.ts"],"sourcesContent":["// Process footnotes\n//\n\nimport * as assert from 'assert';\n\n\n////////////////////////////////////////////////////////////////////////////////\n// Renderer partials\n\nfunction anchorFnDefault(n, excludeSubId, tokens, idx, options, env, slf) {\n  let prefix = '';\n  if (typeof env.docId === 'string' && env.docId.length > 0) {\n    prefix = '-' + env.docId + '-';\n  }\n  return prefix + n;\n}\n\nfunction captionFnDefault(n, tokens, idx, options, env, slf) {\n  //return '[' + n + ']';\n  return '' + n;\n}\n\nfunction headerFnDefault(state) {\n  return '';\n}\n\n\n/*\nref:\n  return `<label aria-describedby=\"fn${id}\" role=\"presentation\" class=\"sidelink\" for=\"fn${id}-content\">\n<a aria-hidden=\"true\" href=\"#fn${id}\"><output class=\"highlight fnref\" id=\"fnref${refid}\">${caption}\n</output></a></label>`;\n\n\nopen:\n  return `<aside id=\"fn${id}\" class=\"sidenote\" role=\"note\">\n    <output aria-hidden=\"true\" class=\"highlight\" id=\"fn${id}-content\">\n    <label role=\"presentation\" for=\"fnref${id}\">`;\n}\n\nfunction render_sidenote_close() {\n  return '</label></output></aside>\\n';\n}\n\n*/\n\nconst default_plugin_options = {\n  // atDocumentEnd: false,               -- obsoleted option of the original plugin\n\n  anchorFn: anchorFnDefault,\n  captionFn: captionFnDefault,\n  headerFn: headerFnDefault,\n\n  // see also https://www.editage.com/insights/footnotes-in-tables-part-1-choice-of-footnote-markers-and-their-sequence\n  // why asterisk/star is not part of the default footnote marker sequence.\n  //\n  // For similar reasons, we DO NOT include the section § symbol in this list.\n  //\n  // when numberSequnce is NULL/empty, a regular numerical numbering is assumed.\n  // Otherwise, the array is indexed; when there are more footnotes than entries in\n  // the numberSequence array, the entries are re-used, but doubled/trippled, etc.\n  //\n  // When the indexing in this array hits a NUMERIC value (as last entry), any higher\n  // footnotes are NUMBERED starting at that number.\n  //\n  // NOTE: as we can reference the same footnote from multiple spots, we do not depend\n  // on CSS counter() approaches by default, but providee this mechanism in the plugin\n  // code itself.\n  numberSequence: [ '†', '‡', '††', '‡‡', '¶', 1 ],\n\n  // Overrides the footnode mode when set to one of the following:\n  //\n  // Recognized 'modes':\n  // '>': aside note (default for inline notes)\n  // ':': end node\n  // '=': section note (default for regular referenced notes)\n  //\n  modeOverride: null,\n\n  // list section notes and endnotes in order of:\n  //\n  // 0: first *appearance* in the text\n  // 1: first *reference* in the text\n  // 2: *definition* in the text\n  // 3: sorted alphabetically by label (inline footnotes will end up at the top, before all other notes)\n  sortOrder: 2,\n}\n\nexport default function footnote_plugin(md, plugin_options) {\n  let parseLinkLabel = md.helpers.parseLinkLabel,\n      isSpace = md.utils.isSpace;\n\n  plugin_options = Object.assign({}, plugin_options, default_plugin_options);\n\n  function determine_mode(mode: string, default_mode: string) {\n    if (plugin_options.modeOverride && '>:='.includes(plugin_options.modeOverride)) {\n      return {\n        mode: plugin_options.modeOverride,\n        fromInput: false\n      };\n    }\n    if ('>:='.includes(mode)) {\n      return {\n        mode,\n        fromInput: true\n      };\n    }\n    return {\n      mode: default_mode,\n      fromInput: false\n    };\n  }\n\n  function determine_footnote_symbol(idx) {\n    if (plugin_options.numberSequence == null || plugin_options.numberSequence.length === 0) { return idx + 1; }\n    const len = plugin_options.numberSequence.length;\n    if (idx >= len) {\n      // is last slot numeric or alphabetical?\n      let slot = plugin_options.numberSequence[len - 1];\n      if (Number.isFinite(slot)) {\n        let delta = idx - len + 1;\n        return slot + delta;\n      }\n\n        // non-numerical last slot --> duplicate, triplicate, etc.\n      let dupli = (idx / len) | 0;  // = int(x mod N)\n      let remainder = idx % len;\n      let core = plugin_options.numberSequence[remainder];\n      let str = core;\n      for (let i = 1; i < dupli; i++) {\n        str += core;\n      }\n      return str;\n\n    }\n\n    return plugin_options.numberSequence[idx];\n  }\n\n  function render_footnote_n(tokens, idx, excludeSubId) {\n    let mark = tokens[idx].meta.id + 1;\n    let n = '' + mark; // = mark.toString();\n\n    if (!excludeSubId && tokens[idx].meta.subId > 0) {\n      n += '-' + tokens[idx].meta.subId;\n    }\n\n    return n;\n  }\n\n  function render_footnote_mark(tokens, idx, env) {\n    let token = tokens[idx];\n    let info = env.footnotes.list[token.meta.id];\n    let labelOverride = info?.labelOverride;\n    let mark = labelOverride || determine_footnote_symbol(token.meta.id);\n    let n = '' + mark; // = mark.toString();\n    return n;\n  }\n\n  function render_footnote_anchor_name(tokens, idx, options, env, slf) {\n    let n = render_footnote_n(tokens, idx, true);\n    return plugin_options.anchorFn(n, true, tokens, idx, options, env, slf);\n  }\n\n  function render_footnote_anchor_nameRef(tokens, idx, options, env, slf) {\n    let n = render_footnote_n(tokens, idx, false);\n    return plugin_options.anchorFn(n, false, tokens, idx, options, env, slf);\n  }\n\n  function render_footnote_caption(tokens, idx, options, env, slf) {\n    let n = render_footnote_mark(tokens, idx, env);\n    return plugin_options.captionFn(n, tokens, idx, options, env, slf);\n  }\n\n  function render_footnote_ref(tokens, idx, options, env, slf) {\n    let id      = render_footnote_anchor_name(tokens, idx, options, env, slf);\n    let caption = render_footnote_caption(tokens, idx, options, env, slf);\n    let refid   = render_footnote_anchor_nameRef(tokens, idx, options, env, slf);\n\n    // check if multiple footnote references are bunched together:\n    // IFF they are, we should separate them with commas.\n    //\n    // Exception: when next token has an extra text (`meta.text`) the\n    // bunching together is not a problem as them the output will render\n    // like this: `bla<sup>1</sup><a>text<sup>2</sup></a>`, ergo a look\n    // like this: `bla¹text²` instead of bunched footnotes references ¹ and ²\n    // that would (without the extra comma injection) look like `bla¹²` instead\n    // of `x¹⁺²` (here '+' instead of ',' comma, but you get the idea -- there's no\n    // Unicode superscript-comma so that's why I used unicode superscript-plus\n    // in this 'ascii art' example).\n    //\n    const next_token = tokens[idx + 1] || {};\n    const next_token_meta = next_token.meta || {};\n    const bunched_footnote_refs = next_token.type === 'footnote_ref' && !next_token_meta.text;\n\n    if (tokens[idx].meta.text) {\n      return '<a href=\"#fn' + id + '\" id=\"fnref' + refid + '\">' +\n            tokens[idx].meta.text +\n            '<sup class=\"footnote-ref\">' + caption + '</sup></a>' +\n            (bunched_footnote_refs ? '<sup class=\"footnote-ref\">,</sup>' : '');\n    }\n\n    return `<sup class=\"footnote-ref\"><a href=\"#fn${ id }\" id=\"fnref${ refid }\">${ caption }</a>${ bunched_footnote_refs ? ',' : '' }</sup>`;\n  }\n\n  function render_footnote_block_open(tokens, idx, options) {\n    let header = tokens[idx].markup;\n    return (options.xhtmlOut ? '<hr class=\"footnotes-sep\" />\\n' : '<hr class=\"footnotes-sep\">\\n') +\n         '<section class=\"footnotes\">\\n' +\n           (header ? '<h3 class=\"footnotes-header\">' + header + '</h3>' : '') +\n         '<ul class=\"footnotes-list\">\\n';\n  }\n\n  function render_footnote_block_close() {\n    return '</ul>\\n</section>\\n';\n  }\n\n  function render_footnote_reference_open(tokens, idx, options) {\n    return '<!-- footnote reference start -->\\n';\n  }\n\n  function render_footnote_reference_close() {\n    return '<!-- footnote reference end -->\\n';\n  }\n\n  function render_footnote_mark_end_of_block() {\n    return '<!-- footnote dump marker -->\\n';\n  }\n\n  function render_footnote_open(tokens, idx, options, env, slf) {\n    let id = render_footnote_anchor_name(tokens, idx, options, env, slf);\n    let caption = render_footnote_caption(tokens, idx, options, env, slf);\n\n    // allow both a JavaWScript --> CSS approach via `data-footnote-caption`\n    // and a classic CSS approach while a display:inline-block SUP presenting\n    // the LI 'button' instead:\n    return `<li tabindex=\"-1\" id=\"fn${ id }\" class=\"footnote-item\" data-footnote-caption=\"${ caption }\"><span class=\"footnote-caption\"><sup class=\"footnote-caption\">${ caption }</sup></span><span class=\"footnote-content\">`;\n  }\n\n  function render_footnote_close() {\n    return '</span></li>\\n';\n  }\n\n  function render_footnote_anchor(tokens, idx, options, env, slf) {\n    let refid = render_footnote_n(tokens, idx, false);\n    refid = plugin_options.anchorFn(refid, false, tokens, idx, options, env, slf);\n\n    /* ↩ with escape code to prevent display as Apple Emoji on iOS */\n    return ' <a href=\"#fnref' + refid + '\" class=\"footnote-backref\">\\u21a9\\uFE0E</a>';\n  }\n\n\n  md.renderer.rules.footnote_ref          = render_footnote_ref;\n  md.renderer.rules.footnote_block_open   = render_footnote_block_open;\n  md.renderer.rules.footnote_block_close  = render_footnote_block_close;\n  md.renderer.rules.footnote_reference_open   = render_footnote_reference_open;\n  md.renderer.rules.footnote_reference_close  = render_footnote_reference_close;\n  md.renderer.rules.footnote_mark_end_of_block = render_footnote_mark_end_of_block;\n  md.renderer.rules.footnote_open         = render_footnote_open;\n  md.renderer.rules.footnote_close        = render_footnote_close;\n  md.renderer.rules.footnote_anchor       = render_footnote_anchor;\n\n  function obtain_footnote_info_slot(env, label?: string) {\n    if (!env.footnotes) { \n      env.footnotes = { \n        // map label tto ID:\n        refs: {},  \n        // store footnote info indexed by ID\n        list: [], \n        //TODO: remap ID to re-ordered ID (determines placement order for section notes and endnotes)\n        idMap: [], \n      }; \n    }\n\n    // When label is NULL, this is a request from in INLINE NOTE.\n\n    // NOTE: IDs are index numbers, BUT they start at 1 instead of 0 to make life easier in check code:\n    let footnoteId;\n    let infoRec;\n    // label as index: prepend ':' to avoid conflict with Object.prototype members\n    if (label == null || !env.footnotes.refs[':' + label]) {\n      footnoteId = env.footnotes.list.length + 1;\n      infoRec = {\n        id: footnoteId,\n        label,\n        labelOverride: null,\n        mode: null,\n        content: null,\n        tokens: null,\n        count: 0\n      };\n      env.footnotes.list[footnoteId] = infoRec;\n      if (label != null) {\n        env.footnotes.refs[':' + label] = footnoteId;\n      }\n    } else {\n      footnoteId = env.footnotes.refs[':' + label];\n      infoRec = env.footnotes.list[footnoteId];\n      console.assert(!!infoRec, \"expects non-NULL footnote info record\");\n    }\n    return infoRec;\n  }\n\n  function find_end_of_block_marker(state, startIndex) {\n    let idx, len;\n    let tokens = state.tokens;\n    for (idx = startIndex, len = tokens.length; idx < len; idx++) {\n      if (tokens[idx].type === 'footnote_mark_end_of_block') { return idx; }\n    }\n    //console.error({ tok: tokens.slice(startIndex), startIndex, idx, len });\n    //throw Error('Should never get here!');\n\n    // Punch a slot into the token stream (at the very end)\n    // for consistency with footnote_mark_end_of_block():\n    //footnote_mark_end_of_block(state, startLine, endLine, silent);\n    let token = new state.Token('footnote_mark_end_of_block', '', 0);\n    token.hidden = true;\n    //token.meta = {\n    //  EndOfFile: true\n    //};\n    tokens.push(token);\n    return tokens.length - 1;\n  }\n\n  function update_end_of_block_marker(state, footnoteId) {\n    // inject marker into parent = block level token stream to announce the advent of an (inline) footnote:\n    // because the markdown_it code uses a for() loop to go through the parent nodes while parsing the\n    // 'inline' chunks, we CANNOT safely inject a marker BEFORE the chunk, only AFTERWARDS:\n    let parentState = state.env.parentState;\n    let parentIndex = state.env.parentTokenIndex;\n    let markerTokenIndex = find_end_of_block_marker(parentState, parentIndex + 1);\n    let token = parentState.tokens[markerTokenIndex];\n    if (!token.meta) token.meta = {};\n    if (!token.meta.footnote_list) token.meta.footnote_list = [];\n    token.meta.footnote_list.push(footnoteId);\n  }\n\n  // Mark end of paragraph/heading/whatever BLOCK (or rather: START of the next block!)\n  function footnote_mark_end_of_block(state, startLine, endLine, silent) {\n    if (!silent && state.tokens.length > 0) {\n      let token = state.push('footnote_mark_end_of_block', '', 0);\n      token.hidden = true;\n    }\n    return false;\n  }\n\n  // Process footnote block definition\n  function footnote_def(state, startLine, endLine, silent) {\n    let oldBMark, oldTShift, oldSCount, oldParentType, pos, label, token,\n        initial, offset, ch, posAfterColon,\n        start = state.bMarks[startLine] + state.tShift[startLine],\n        max = state.eMarks[startLine];\n\n    // line should be at least 6 chars - \"[^x]: \" or \"[^x]:> \"\n    if (start + 5 > max) { return false; }\n\n    if (state.src.charCodeAt(start) !== 0x5B/* [ */) { return false; }\n    if (state.src.charCodeAt(start + 1) !== 0x5E/* ^ */) { return false; }\n\n    for (pos = start + 2; pos < max; pos++) {\n      if (state.src.charCodeAt(pos) === 0x0A /* LF */) { return false; }\n      if (state.src.charCodeAt(pos) === 0x5D /* ] */) {\n        break;\n      }\n    }\n    let labelEnd = pos;\n\n    if (pos === start + 2) { return false; } // no empty footnote labels\n    if (pos + 1 >= max || state.src.charCodeAt(++pos) !== 0x3A /* : */) { return false; }\n\n    let mode_rec = determine_mode(state.src[pos + 1], '=');   // default mode is section_note mode.\n    if (mode_rec.fromInput) \n      pos++;\n    let mode = mode_rec.mode;\n\n    if (pos + 1 >= max || state.src.charCodeAt(++pos) !== 0x20 /* space */) { return false; }\n    if (silent) { return true; }\n    pos++;\n\n    label = state.src.slice(start + 2, labelEnd);\n    let text;\n    if (label.match(/^(\\S+)\\s+(.+)$/)) {\n      label = RegExp.$1;\n      text = RegExp.$2;\n    }\n\n    console.error('extracted label = ', { label, text, labelEnd, pos, start });\n\n    // Now see if we already have a footnote ID for this footnote label:\n    // fetch it if we have one and otherwise produce a new one so everyone\n    // can use this from now on. \n    //\n    // This scenario is possible when the footnote *definition* comes BEFORE\n    // the first actual footnote *use* (*reference*). This is UNUSUAL when people\n    // write texts, but it is *not impossible*, particularly now that we have\n    // specified-by-design that endnotes can be marked as such (`[^label]:: note text`)\n    // and freely mixed with sidenotes (`[^label]:> note text`) and section \n    // notes (`[^label]:= note text` (explicit mode) or `[^label]: note text` \n    // (implicit mode)), where *section notes* will placed at the spot in the text\n    // flow where they were *defined*. Again, highly irregular, BUT someone MAY\n    // feel the need to place some section note *definitions* ABOVE their first\n    // use point.\n    //\n    let infoRec = obtain_footnote_info_slot(state.env, label);\n\n    infoRec.labelOverride = text;\n    infoRec.mode = mode;\n\n    token = state.push('footnote_reference_open', '', 1);\n    token.meta = {\n      id: infoRec.id,\n    };\n    token.hidden = true;\n\n    oldBMark = state.bMarks[startLine];\n    oldTShift = state.tShift[startLine];\n    oldSCount = state.sCount[startLine];\n    oldParentType = state.parentType;\n\n    posAfterColon = pos;\n    initial = offset = state.sCount[startLine] + pos - (state.bMarks[startLine] + state.tShift[startLine]);\n\n    while (pos < max) {\n      ch = state.src.charCodeAt(pos);\n\n      if (isSpace(ch)) {\n        if (ch === 0x09) {\n          offset += 4 - offset % 4;\n        } else {\n          offset++;\n        }\n      } else {\n        break;\n      }\n\n      pos++;\n    }\n\n    state.tShift[startLine] = pos - posAfterColon;\n    state.sCount[startLine] = offset - initial;\n\n    state.bMarks[startLine] = posAfterColon;\n    state.blkIndent += 4;\n    state.parentType = 'footnote';\n\n    if (state.sCount[startLine] < state.blkIndent) {\n      state.sCount[startLine] += state.blkIndent;\n    }\n\n    state.md.block.tokenize(state, startLine, endLine, true);\n\n    state.parentType = oldParentType;\n    state.blkIndent -= 4;\n    state.tShift[startLine] = oldTShift;\n    state.sCount[startLine] = oldSCount;\n    state.bMarks[startLine] = oldBMark;\n\n    token = state.push('footnote_reference_close', '', -1);\n    token.meta = {\n      id: infoRec.id,\n    };\n\n    return true;\n  }\n\n  // Process inline footnotes (^[...] or ^[>...])\n  function footnote_inline(state, silent) {\n    let labelStart,\n        labelEnd,\n        token,\n        tokens,\n        max = state.posMax,\n        start = state.pos;\n\n    if (start + 2 >= max) { return false; }\n    if (state.src.charCodeAt(start) !== 0x5E/* ^ */) { return false; }\n    if (state.src.charCodeAt(start + 1) !== 0x5B/* [ */) { return false; }\n\n    labelStart = start + 2;\n\n    // NOTE: inline notes are automatically considered to be ASIDE notes,\n    // UNLESS otherwise specified!\n    //\n    // Recognized 'modes':\n    // '>': aside note (default for inline notes)\n    // ':': end node\n    // '=': section note (default for regular referenced notes)\n    //\n    // (Also note https://v4.chriskrycho.com/2015/academic-markdown-and-citations.html:\n    // our notes look like this: `[^ref]:` while Academic MarkDown references look\n    // like this: `[@Belawog2012]` i.e. no '^' in there. Hence these can safely co-exist.)\n    //\n    let mode_rec = determine_mode(state.src[start + 2], '>');   // default mode is aside ~ sidenote mode.\n    if (mode_rec.fromInput) \n      labelStart++;\n    let mode = mode_rec.mode;\n\n    labelEnd = parseLinkLabel(state, start + 1);\n\n    // parser failed to find ']', so it's not a valid note\n    if (labelEnd < 0) { return false; }\n\n    // We found the end of the link, and know for a fact it's a valid link;\n    // so all that's left to do is to call tokenizer.\n    //\n    if (!silent) {\n      // inline blocks have their own *child* environment in markdown-it v10+.\n      // As the footnotes must live beyond the lifetime of the inline block env,\n      // we must patch them into the `parentState.env` for the footnote_tail\n      // handler to be able to access them afterwards!\n      let parentState = state.env.parentState;\n      let parentEnv = parentState.env;\n\n      // WARNING: claim our footnote slot for there MAY be nested footnotes\n      // discovered in the next inline.parse() call below!\n      let infoRec = obtain_footnote_info_slot(parentEnv, null);\n      infoRec.mode = mode;\n      infoRec.count++;\n\n      token = state.push('footnote_ref', '', 0);\n      //token.meta = { id: footnoteId, subId: 0, label: null };\n      token.meta = {\n        id: infoRec.id,\n      };\n\n      state.md.inline.parse(\n        state.src.slice(labelStart, labelEnd),\n        state.md,\n        state.env,\n        tokens = []\n      );\n\n      // Now fill our previously claimed slot:\n      infoRec.content = state.src.slice(labelStart, labelEnd);\n      infoRec.tokens = tokens;\n\n      // inject marker into parent = block level token stream to announce the advent of an (inline) footnote:\n      // because the markdown_it code uses a for() loop to go through the parent nodes while parsing the\n      // 'inline' chunks, we CANNOT safely inject a marker BEFORE the chunk, only AFTERWARDS:\n      update_end_of_block_marker(state, infoRec.id);\n\n      //md.block.ruler.enable('footnote_mark_end_of_block');\n    }\n\n    state.pos = labelEnd + 1;\n    state.posMax = max;\n    return true;\n  }\n\n  // Process footnote references with text ([^label ...])\n  function footnote_ref_with_text(state, silent) {\n    let label,\n        pos,\n        footnoteSubId,\n        token,\n        max = state.posMax,\n        start = state.pos;\n\n    // should be at least 6 chars - \"[^l x]\"\n    if (start + 5 > max) { return false; }\n\n    if (state.src.charCodeAt(start) !== 0x5B/* [ */) { return false; }\n    if (state.src.charCodeAt(start + 1) !== 0x5E/* ^ */) { return false; }\n\n    for (pos = start + 2; pos < max; pos++) {\n      if (state.src.charCodeAt(pos) === 0x0A /* linefeed */) { return false; }\n      if (state.src.charCodeAt(pos) === 0x5D /* ] */) {\n        break;\n      }\n    }\n\n    if (pos === start + 2) { return false; } // no empty footnote labels\n    if (pos >= max) { return false; }\n    pos++;\n\n    label = state.src.slice(start + 2, pos - 1);\n    if (!label || !label.match(/^(\\S+)\\s+(.+)$/)) { return false; }\n    label = RegExp.$1;\n    let text = RegExp.$2;\n\n    let infoRec = obtain_footnote_info_slot(state.env, label);\n\n    if (!silent) {\n      footnoteSubId = infoRec.count;\n\n      infoRec.count++;\n\n      token = state.push('footnote_ref', '', 0);\n      token.meta = {\n        id: infoRec.id,\n        subId: footnoteSubId,\n      };\n\n      update_end_of_block_marker(state, infoRec.id);\n\n      //md.block.ruler.enable('footnote_mark_end_of_block');\n    }\n\n    state.pos = pos;\n    state.posMax = max;\n    return true;\n  }\n\n  // Process footnote references ([^...])\n  function footnote_ref(state, silent) {\n    let label,\n        pos,\n        footnoteSubId,\n        token,\n        max = state.posMax,\n        start = state.pos;\n\n    // should be at least 4 chars - \"[^x]\"\n    if (start + 3 > max) { return false; }\n\n    if (state.src.charCodeAt(start) !== 0x5B/* [ */) { return false; }\n    if (state.src.charCodeAt(start + 1) !== 0x5E/* ^ */) { return false; }\n\n    for (pos = start + 2; pos < max; pos++) {\n      if (state.src.charCodeAt(pos) === 0x20) { return false; }\n      if (state.src.charCodeAt(pos) === 0x0A) { return false; }\n      if (state.src.charCodeAt(pos) === 0x5D /* ] */) {\n        break;\n      }\n    }\n\n    if (pos === start + 2) { return false; } // no empty footnote labels\n    if (pos >= max) { return false; }\n    pos++;\n\n    label = state.src.slice(start + 2, pos - 1);\n\n    let infoRec = obtain_footnote_info_slot(state.env, label);\n\n    if (!silent) {\n      footnoteSubId = infoRec.count;\n      \n      infoRec.count++;\n\n      token = state.push('footnote_ref', '', 0);\n      token.meta = {\n        id: infoRec.id,\n        subId: footnoteSubId,\n      };\n\n      update_end_of_block_marker(state, infoRec.id);\n\n      //md.block.ruler.enable('footnote_mark_end_of_block');\n    }\n\n    state.pos = pos;\n    state.posMax = max;\n    return true;\n  }\n\n  // Glue footnote tokens into appropriate slots of token stream.\n  function footnote_tail(state, startLine, endLine, silent) {\n    let i, l, j, t, lastParagraph, token, tokens, current, currentRefToken,\n        insideRef = false,\n        refTokens = {};\n\n    console.error('@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ TAIL');\n    if (!state.env.footnotes) {\n      // no footnotes at all? --> filter out all 'footnote_mark_end_of_block' chunks:\n      state.tokens = state.tokens.filter(function (tok, idx) {\n        return (tok.type !== 'footnote_mark_end_of_block');\n      });\n      return;\n    }\n\n    // Rewrite the tokenstream to place the aside-footnotes and section footnotes where they need to be:\n    let aside_list = [];\n    let section_list = [];\n    let end_list = [];\n\n    let list = state.env.footnotes.list;\n\n    // extract the tokens constituting the footnote/sidenote *content* and\n    // store that bunch in `refTokens[:<currentLabel>]` instead, to be injected back into\n    // the tokenstream at the appropriate spots.\n    state.tokens = state.tokens.filter(function (tok, idx) {\n      switch (tok.type) {\n      // filter out 'footnote_mark_end_of_block' tokens which follow BLOCKS that do not contain any\n      // footnote/sidenote/endnote references:\n      case 'footnote_mark_end_of_block':\n        if (!tok.meta) return false;\n        if (!tok.meta.footnote_list) return false;\n        break;\n\n      case 'footnote_reference_open':\n        insideRef = true;\n        current = [];\n        currentRefToken = tok;\n/*\n        if (tok.meta.mode === '>') {\n          aside_list.push(idx);\n        }\n*/\n        return true;\n\n      case 'footnote_reference_close':\n        insideRef = false;\n\n        let infoRec = list[tok.meta.id];\n        infoRec.tokens = current;\n\n        return true;\n      }\n      if (insideRef) {\n        current.push(tok);\n      }\n      return !insideRef;\n    });\n\n    let inject_tokens = [];\n\n    token = new state.Token('footnote_block_open', '', 1);\n    token.markup = plugin_options.headerFn(state);\n    inject_tokens.push(token);\n\n    // REMEMBER: we're indexing from 1 for footnote IDs instead of from zero(0),\n    // so the first slot (`list[0]`) will be NULL:\n    console.error(\"!!!!!!!!!!!!! list:\", list)\n    for (i = 1, l = list.length; i < l; i++) {\n      let fn = list[i];\n      let inject_start_index = inject_tokens.length;\n\n      token      = new state.Token('footnote_open', '', 1);\n      token.meta = {\n        id: i,\n      };\n      inject_tokens.push(token);\n\n      if (fn.tokens) {\n        // process an inline footnote text:\n        token          = new state.Token('paragraph_open', 'p', 1);\n        token.block    = true;\n        inject_tokens.push(token);\n\n        token          = new state.Token('inline', '', 0);\n        token.children = fn.tokens;\n        token.content  = fn.content;\n        inject_tokens.push(token);\n\n        token          = new state.Token('paragraph_close', 'p', -1);\n        token.block    = true;\n        inject_tokens.push(token);\n      } else if (fn.label) {\n        // process a labeled footnote:\n        inject_tokens = inject_tokens.concat(fn.tokens || []);\n      } else {\n        // nothing to inject\n        throw Error('unexpected: should never get here!');\n      }\n\n      if (inject_tokens[inject_tokens.length - 1].type === 'paragraph_close') {\n        lastParagraph = inject_tokens.pop();\n      } else {\n        lastParagraph = null;\n      }\n\n      t = fn.count;\n      if (t < 1) {\n        console.error(`footnote ID ${i} is defined but never used. Footnote will be removed from the output!`, fn);\n        inject_tokens = inject_tokens.slice(0, inject_start_index);\n      }\n      else {\n        for (j = 0; j < t; j++) {\n          token = new state.Token('footnote_anchor', '', 0);\n          token.meta = {\n            id: i,\n            subId: j,\n          };\n          inject_tokens.push(token);\n        }\n\n        if (lastParagraph) {\n          inject_tokens.push(lastParagraph);\n        }\n\n        token = new state.Token('footnote_close', '', -1);\n        token.meta = {\n          id: i,\n        };\n        inject_tokens.push(token);\n      }\n    }\n\n    token = new state.Token('footnote_block_close', '', -1);\n    inject_tokens.push(token);\n    state.tokens.splice(state.tokens.length, 0, ...inject_tokens);\n\n    // Update state_block too as we have rewritten & REPLACED the token array earlier in this call:\n    // the reference `state.env.state_block.tokens` is still pointing to the OLD token array!\n    state.env.state_block.tokens = state.tokens;\n  }\n\n  // attach ourselves to the start of block handling too\n  md.block.ruler.before('table', 'footnote_mark_end_of_block', footnote_mark_end_of_block);\n\n  md.block.ruler.before('reference', 'footnote_def', footnote_def, { alt: [ 'paragraph', 'reference' ] });\n  md.inline.ruler.after('image', 'footnote_inline', footnote_inline);\n  md.inline.ruler.after('footnote_inline', 'footnote_ref_with_text', footnote_ref_with_text);\n  md.inline.ruler.after('footnote_ref_with_text', 'footnote_ref', footnote_ref);\n  md.core.ruler.after('inline', 'footnote_tail', footnote_tail);\n}\n"],"names":["anchorFnDefault","n","excludeSubId","tokens","idx","options","env","slf","prefix","docId","length","captionFnDefault","headerFnDefault","state","default_plugin_options","anchorFn","captionFn","headerFn","numberSequence","modeOverride","sortOrder","footnote_plugin","md","plugin_options","parseLinkLabel","helpers","isSpace","utils","Object","assign","determine_mode","mode","default_mode","includes","fromInput","determine_footnote_symbol","len","slot","Number","isFinite","delta","dupli","remainder","core","str","i","render_footnote_n","mark","meta","id","subId","render_footnote_mark","token","info","footnotes","list","labelOverride","render_footnote_anchor_name","render_footnote_anchor_nameRef","render_footnote_caption","render_footnote_ref","caption","refid","next_token","next_token_meta","bunched_footnote_refs","type","text","render_footnote_block_open","header","markup","xhtmlOut","render_footnote_block_close","render_footnote_reference_open","render_footnote_reference_close","render_footnote_mark_end_of_block","render_footnote_open","render_footnote_close","render_footnote_anchor","renderer","rules","footnote_ref","footnote_block_open","footnote_block_close","footnote_reference_open","footnote_reference_close","footnote_mark_end_of_block","footnote_open","footnote_close","footnote_anchor","obtain_footnote_info_slot","label","refs","idMap","footnoteId","infoRec","content","count","console","assert","find_end_of_block_marker","startIndex","Token","hidden","push","update_end_of_block_marker","parentState","parentIndex","parentTokenIndex","markerTokenIndex","footnote_list","startLine","endLine","silent","footnote_def","oldBMark","oldTShift","oldSCount","oldParentType","pos","initial","offset","ch","posAfterColon","start","bMarks","tShift","max","eMarks","src","charCodeAt","labelEnd","mode_rec","slice","match","RegExp","$1","$2","error","sCount","parentType","blkIndent","block","tokenize","footnote_inline","labelStart","posMax","parentEnv","inline","parse","footnote_ref_with_text","footnoteSubId","footnote_tail","l","j","t","lastParagraph","current","insideRef","filter","tok","inject_tokens","fn","inject_start_index","children","concat","Error","pop","splice","state_block","ruler","before","alt","after"],"mappings":"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"}